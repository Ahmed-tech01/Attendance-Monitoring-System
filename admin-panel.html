<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Panel - TEC Attendance</title>
  <link rel="stylesheet" href="./css/Style.css">
  <style>
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    table, th, td {
      border: 1px solid #ccc;
    }
    th, td {
      padding: 10px;
      text-align: left;
    }
    .hidden {
      display: none;
    }
  </style>
</head>
<body>
  <div class="form-container">
    <h2>Admin Dashboard - TEC Attendance</h2>

    <button onclick="downloadCSV()">📥 Download Attendance Data</button>
    <div class="form-section">
  <h3>Create New User Account</h3>
  <form id="create-user-form">
    <label>Username</label>
    <input type="text" name="Username" required>

    <label>Password</label>
    <input type="password" name="Password" required>

    <button type="submit">Create Account</button>
  </form>
  <p id="account-message"></p>
</div>

    <button onclick="showSubmissions()">📄 View Attendance Submissions</button>
    <button onclick="logout()">🔓 Logout</button>

    <div id="usersTableContainer" class="hidden">
      <h3>Registered Users</h3>
      <table id="usersTable">
        <thead>
          <tr><th>UserID</th><th>Username</th><th>Role</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div id="submissionsTableContainer" class="hidden">
      <h3>User Attendance Submissions</h3>
      <table id="submissionsTable">
        <thead>
          <tr><th>Person Name</th><th>Project</th><th>Supervisor</th><th>Start Time</th><th>End Time</th><th>Location</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    <button id="downloadBtn">📤 Download Attendance Data (CSV)</button>
<p id="download-status"></p>

  </div>

  <script>
    // Protect page
    if (!localStorage.getItem("adminLoggedIn")) {
      alert("Access denied. Login required.");
      window.location.href = "adminLogin.html";
    }

    function logout() {
      localStorage.removeItem("adminLoggedIn");
      window.location.href = "admin-login.html";
    }

    function downloadCSV() {
      google.script.run.withSuccessHandler(function(url) {
        window.open(url);
      }).downloadAttendanceCSV();
    }

    function showUsers() {
      document.getElementById("usersTableContainer").classList.remove("hidden");
      google.script.run.withSuccessHandler(function(users) {
        const tbody = document.querySelector("#usersTable tbody");
        tbody.innerHTML = "";
        users.forEach(row => {
          const tr = document.createElement("tr");
          tr.innerHTML = `<td>${row[0]}</td><td>${row[1]}</td><td>${row[2]}</td>`;
          tbody.appendChild(tr);
        });
      }).getRegisteredUsers();
    }

    function showSubmissions() {
      document.getElementById("submissionsTableContainer").classList.remove("hidden");
      google.script.run.withSuccessHandler(function(records) {
        const tbody = document.querySelector("#submissionsTable tbody");
        tbody.innerHTML = "";
        records.forEach(row => {
          const tr = document.createElement("tr");
          tr.innerHTML = `<td>${row[0]}</td><td>${row[1]}</td><td>${row[2]}</td><td>${row[3]}</td><td>${row[4]}</td><td>${row[5]}</td>`;
          tbody.appendChild(tr);
        });
      }).getAttendanceSubmissions();
    }
  </script>
  <script>
  const downloadBtn = document.getElementById('downloadBtn');
  const downloadStatus = document.getElementById('download-status');

  downloadBtn.addEventListener('click', () => {
    downloadStatus.textContent = "⏳ Preparing download...";

    // Replace with your deployed Apps Script web app URL
    const downloadURL = 'https://script.google.com/macros/s/YOUR_SCRIPT_ID/exec?action=download';

    fetch(downloadURL)
      .then(res => res.blob())
      .then(blob => {
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'AttendanceData.csv';
        document.body.appendChild(a);
        a.click();
        a.remove();
        downloadStatus.textContent = "✅ Download started!";
      })
      .catch(err => {
        console.error('Error downloading:', err);
        downloadStatus.textContent = "❌ Failed to download. Try again.";
      });
  });
</script>
<script>
  const accountForm = document.getElementById("create-user-form");
  const accountMsg = document.getElementById("account-message");

  accountForm.addEventListener("submit", function(e) {
    e.preventDefault();

    const formData = new FormData(accountForm);

    fetch("https://script.google.com/macros/s/AKfycbw5uNOhsaJp3w3ZrA5aJItW-X3laz_6KpXXTs39UzWApAd9-4F0gCot38KmH_2MGzJZhw/exec", {
      method: "POST",
      body: formData
    })
    .then(res => res.text())
    .then(response => {
      accountMsg.textContent = "✅ Account created successfully!";
      accountForm.reset();
    })
    .catch(error => {
      accountMsg.textContent = "❌ Failed to create account.";
      console.error("Error:", error);
    });
  });
</script>


</body>
</html>
